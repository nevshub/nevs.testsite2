<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Updates</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Grove Updates</h1>

  <!-- Post Form -->
  <div id="postForm" style="display:none;">
    <h2>New Update</h2>
    <input type="text" id="updateTitle" placeholder="Title" required><br><br>
    <textarea id="updateContent" placeholder="Your update..." required></textarea><br><br>
    <button id="postUpdate">Post</button>
  </div>

  <!-- Updates Feed -->
  <div id="updatesFeed"></div>

  <script>
    const role = localStorage.getItem("userRole"); // "admin" or "member"
    const loggedInUser = localStorage.getItem("loggedInUser") || "Guest";

    const postForm = document.getElementById("postForm");
    const updatesFeed = document.getElementById("updatesFeed");

    // Show post form for members and admin
    if(role === "admin" || role === "member") postForm.style.display = "block";

    // Load updates
    let updates = JSON.parse(localStorage.getItem("updates") || "[]");

    function renderUpdates() {
      updatesFeed.innerHTML = "";
      // Sort pinned first
      const sorted = updates.sort((a,b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));
      sorted.forEach(update => {
        const div = document.createElement("div");
        div.className = "update";
        div.innerHTML = `
          <h3>${update.title}</h3>
          <p>${update.content}</p>
          <small>By: ${update.author} | ${update.timestamp}</small><br>
          Likes: <span>${update.likes}</span>
          <button class="likeBtn" data-id="${update.id}">Like</button>
          <button class="commentBtn" data-id="${update.id}">Comment</button>
          ${role === "admin" ? `<button class="deleteBtn" data-id="${update.id}">Delete</button>
          <button class="pinBtn" data-id="${update.id}">${update.pinned ? "Unpin" : "Pin"}</button>` : ""}
          <div class="comments" id="comments-${update.id}"></div>
          <hr>
        `;
        updatesFeed.appendChild(div);

        // Render comments
        const commentsDiv = document.getElementById(`comments-${update.id}`);
        update.comments.forEach(c => {
          const cDiv = document.createElement("div");
          cDiv.innerText = `${c.author}: ${c.text}`;
          commentsDiv.appendChild(cDiv);
        });
      });
    }

    renderUpdates();

    // Posting new update
    document.getElementById("postUpdate").addEventListener("click", () => {
      const title = document.getElementById("updateTitle").value.trim();
      const content = document.getElementById("updateContent").value.trim();
      if(!title || !content) return alert("Title and content required");

      const newUpdate = {
        id: Date.now(),
        title,
        content,
        author: role === "admin" ? "Admin" : loggedInUser,
        timestamp: new Date().toLocaleString(),
        likes: 0,
        comments: [],
        pinned: false
      };
      updates.unshift(newUpdate);
      localStorage.setItem("updates", JSON.stringify(updates));
      renderUpdates();
    });

    // Like, comment, delete, pin
    updatesFeed.addEventListener("click", e => {
      const id = e.target.dataset.id;
      if(!id) return;
      const update = updates.find(u => u.id == id);

      if(e.target.classList.contains("likeBtn")) {
        update.likes++;
      } else if(e.target.classList.contains("commentBtn")) {
        const text = prompt("Comment:");
        if(text) update.comments.push({author: loggedInUser, text});
      } else if(e.target.classList.contains("deleteBtn") && role === "admin") {
        updates = updates.filter(u => u.id != id);
      } else if(e.target.classList.contains("pinBtn") && role === "admin") {
        update.pinned = !update.pinned;
      }

      localStorage.setItem("updates", JSON.stringify(updates));
      renderUpdates();
    });
  </script>
</body>
</html>
